<!DOCTYPE html>
<html>
  <head>
    <title>Recent Orders - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        background-color: #fdfaf6;
        font-family: "Segoe UI", sans-serif;
      }
      .container {
        padding: 30px 15px;
        max-width: 1200px;
      }
      h4 {
        color: #d35400;
        margin-bottom: 25px;
        text-align: center;
        font-weight: 700;
      }
      .btn-back {
        background-color: #e67e22;
        border: none;
        color: white;
        padding: 10px 18px;
        font-weight: 600;
        text-decoration: none;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }
      .btn-back:hover {
        background-color: #cf711f;
      }
      .order-card {
        background-color: rgb(90, 96, 98);
        border-radius: 14px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        padding: 10px;
      }
      .order-header {
        border: 2px solid #f1c40f;
        background-color: #fffef0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
      }
      .order-products {
        border: 2px solid #3498db;
        background-color: #f0f8ff;
        border-radius: 12px;
        padding: 20px;
      }
      .order-label {
        font-weight: 600;
        color: #333;
        display: inline-block;
        min-width: 140px;
      }
      .order-product {
        border-top: 1px dashed #aaa;
        margin-top: 12px;
        padding-top: 12px;
      }
      .download-btn, .export-btn, .toggle-btn {
        background: #2980b9;
        border: none;
        color: white;
        padding: 8px 14px;
        font-size: 14px;
        border-radius: 6px;
        margin-top: 12px;
        transition: 0.2s;
      }
      .download-btn:hover, .export-btn:hover, .toggle-btn:hover {
        background-color: #216a94;
      }
      .search-bar {
        margin: 20px 0 30px;
      }
      .search-bar input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e67e22;
        border-radius: 8px;
        font-size: 16px;
      }
      .analytics {
        margin: 30px 0;
        display: none;
      }
      .analytics canvas {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/admin-dashboard" class="btn-back mb-4 d-inline-block">â¬… Back to Dashboard</a>
      <h4>ðŸ“¦ Recent Orders</h4>

      <!-- ðŸ” Search Bar -->
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Search by Order ID, Name, Payment ID, or Contact Number" onkeyup="filterOrders()" />
      </div>

      <!-- ðŸ“Š Toggle Analytics Button -->
      <button class="toggle-btn mb-3" onclick="toggleAnalytics()">Analytics</button>

      <!-- ðŸ“ˆ Analytics Section -->
      <div class="analytics" id="analyticsSection">
        <h5>Total Revenue: â‚¹<span id="totalRevenue">0</span></h5>
        <label for="monthFilter">ðŸ“… Filter by Month:</label>
        <select id="monthFilter" onchange="filterByMonth()" class="form-select mb-3" style="max-width: 300px">
          <option value="all">All</option>
        </select>
        <button class="export-btn" onclick="exportAnalyticsToPDF()">ðŸ“¤ Export Analytics to PDF</button>
        <canvas id="revenueChart" height="100"></canvas>
        <canvas id="lineChart" height="100"></canvas>
        <canvas id="pieChart" height="100"></canvas>
      </div>

      <!-- ðŸ§¾ Orders -->
      <div id="ordersWrapper">
        {% for payment_id, items in grouped_orders.items() %}
        <div class="order-card order-block">
          <div class="order-header">
            <p><span class="order-label">Order ID:</span> {{ items[0].order_id }}</p>
            <p><span class="order-label">Payment ID:</span> {{ payment_id }}</p>
            <p><span class="order-label">User:</span> {{ items[0].user_name }}</p>
            <p><span class="order-label">Contact:</span> {{ items[0].mobile or 'N/A' }}</p>
            <p><span class="order-label">Address:</span> {{ items[0].full_address or 'N/A' }}</p>
          </div>
          <div class="order-products">
            {% for item in items %}
            <div class="order-product">
              <p><span class="order-label">Product:</span> {{ item.product_name }}</p>
              <p><span class="order-label">Size:</span> {{ item.size or 'N/A' }}</p>
              <p><span class="order-label">Price:</span> â‚¹{{ item.price }}</p>
              <p><span class="order-label">Order Time:</span> {{ item.order_time }}</p>
            </div>
            {% endfor %}
            <button class="download-btn" onclick='downloadCartInvoice({{ items | tojson | safe }})'>ðŸ“¥ Download Full Invoice</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <script>
      const orderBlocks = document.querySelectorAll('.order-card');
      const totalElement = document.getElementById('totalRevenue');
      const monthSelect = document.getElementById('monthFilter');
      const analyticsSection = document.getElementById('analyticsSection');
      let chart, pieChart, lineChart;
      let revenueData = {}, categoryData = {}, dailyData = {};

      function toggleAnalytics() {
        analyticsSection.style.display = analyticsSection.style.display === 'none' ? 'block' : 'none';
      }

      document.addEventListener('DOMContentLoaded', () => {
        let total = 0;
        const months = new Set();

        orderBlocks.forEach(block => {
          const prices = block.querySelectorAll(".order-product p:nth-child(3)");
          const time = block.innerText.match(/Order Time: (\d{4}-\d{2})/);
          const date = block.innerText.match(/Order Time: (\d{4}-\d{2}-\d{2})/);
          let blockTotal = 0;
          prices.forEach(p => {
            const val = parseFloat(p.innerText.replace(/[^\d.]/g, ''));
            blockTotal += val;
            total += val;
          });

          const monthKey = time ? time[1] : 'Unknown';
          const dayKey = date ? date[1] : 'Unknown';
          months.add(monthKey);

          revenueData[monthKey] = (revenueData[monthKey] || 0) + blockTotal;
          dailyData[dayKey] = (dailyData[dayKey] || 0) + blockTotal;

          const category = block.innerText.match(/Product: (\w+)/);
          if (category) {
            const cat = category[1];
            categoryData[cat] = (categoryData[cat] || 0) + blockTotal;
          }
        });

        totalElement.innerText = total.toFixed(2);
        [...months].sort().forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.innerText = m;
          monthSelect.appendChild(opt);
        });

        drawCharts();
      });

      function drawCharts() {
        const revCtx = document.getElementById('revenueChart');
        if (chart) chart.destroy();
        chart = new Chart(revCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(revenueData).sort(),
            datasets: [{
              label: 'Monthly Revenue (â‚¹)',
              data: Object.keys(revenueData).sort().map(k => revenueData[k]),
              backgroundColor: '#e67e22'
            }]
          }
        });

        const lineCtx = document.getElementById('lineChart');
        if (lineChart) lineChart.destroy();
        lineChart = new Chart(lineCtx, {
          type: 'line',
          data: {
            labels: Object.keys(dailyData).sort(),
            datasets: [{
              label: 'Daily Revenue (â‚¹)',
              data: Object.keys(dailyData).sort().map(k => dailyData[k]),
              borderColor: '#2c3e50',
              fill: false
            }]
          }
        });

        const pieCtx = document.getElementById('pieChart');
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: Object.keys(categoryData),
            datasets: [{
              label: 'Revenue by Product Category',
              data: Object.values(categoryData),
              backgroundColor: ['#e67e22', '#3498db', '#2ecc71', '#9b59b6']
              
              
            }]
          }
        });
      }

      function filterByMonth() {
        const val = monthSelect.value;
        orderBlocks.forEach(block => {
          const match = block.innerText.match(/Order Time: (\d{4}-\d{2})/);
          block.style.display = (val === 'all' || (match && match[1] === val)) ? 'block' : 'none';
        });
      }

      function filterOrders() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        orderBlocks.forEach(block => {
          const text = block.innerText.toLowerCase();
          block.style.display = text.includes(input) ? 'block' : 'none';
        });
      }

      function exportAnalyticsToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Revenue Analytics Report', 20, 20);
        doc.setFontSize(12);

        let y = 40;
        doc.text('Total Revenue: â‚¹' + totalElement.innerText, 20, y);
        y += 10;

        Object.entries(revenueData).forEach(([month, amount]) => {
          doc.text(`${month}: â‚¹${amount.toFixed(2)}`, 20, y);
          y += 8;
        });

        doc.save('revenue_analytics.pdf');
      }
    </script>
  </body>
</html>
